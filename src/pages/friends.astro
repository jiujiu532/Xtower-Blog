---
import { getEntry, render } from "astro:content";
import Markdown from "@components/misc/Markdown.astro";
import I18nKey from "@/i18n/i18nKey";
import { i18n } from "@/i18n/translation";
import MainGridLayout from "@/layouts/MainGridLayout.astro";
import { getEnabledFriends } from "@/config";
import Comment from "@components/comment/index.astro";
import Icon from "@/components/misc/Icon.astro";

const friendsPost = await getEntry("spec", "friends");

if (!friendsPost) {
  throw new Error("friends page content not found");
}

const { Content } = await render(friendsPost);

// 使用配置文件中的友链数据，按权重排序
const items = getEnabledFriends();

// 获取所有标签
const allTags = new Set<string>();
items.forEach(item => {
  if (item.tags) {
    item.tags.forEach(tag => allTags.add(tag));
  }
});

// 页面标题和描述
const title = i18n(I18nKey.friends);
const description = i18n(I18nKey.friendsDescription);
---

<MainGridLayout title={title} description={description}>
  <div class="flex w-full rounded-[var(--radius-large)] overflow-hidden relative min-h-32">
    <div class="card-base z-10 px-9 py-6 relative w-full">
      <!-- 页面标题和描述 -->
      <div class="mb-6">
        <div class="flex items-center gap-3 mb-3">
          <div class="h-8 w-8 rounded-lg bg-[var(--primary)] flex items-center justify-center text-white dark:text-black/70">
            <Icon icon="material-symbols:group" class="text-[1.5rem]"></Icon>
          </div>
          <h1 class="text-3xl font-bold text-neutral-900 dark:text-neutral-100">
            {title}
          </h1>
        </div>
        {description && (
          <p class="text-base text-neutral-600 dark:text-neutral-400 leading-relaxed mb-4">
            {description}
          </p>
        )}
      </div>

      <!-- 友链列表区域 -->
      <div id="friends-section">
        <!-- 搜索框 -->
        <div class="mb-4">
          <div class="relative">
            <Icon icon="material-symbols:search" class="absolute left-3 top-1/2 -translate-y-1/2 text-neutral-400 text-xl"></Icon>
            <input 
              type="text" 
              id="search-input"
              placeholder="搜索友链名称或描述..."
              class="w-full pl-10 pr-4 py-2 rounded-lg bg-neutral-100 dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700 focus:outline-none focus:border-[var(--primary)] transition-colors"
            />
          </div>
        </div>

        <!-- 标签筛选 -->
        <div class="flex gap-2 mb-6 flex-wrap">
          <button class="filter-tag active" data-tag="all">
            全部
          </button>
          {Array.from(allTags).map(tag => (
            <button class="filter-tag" data-tag={tag}>
              {tag}
            </button>
          ))}
        </div>

        <!-- 友链卡片网格 -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="friends-grid">
          {items.map((item) => (
            <div 
              class="friend-card card-base p-4 transition-all hover:shadow-lg"
              data-tags={item.tags?.join(',') || ''}
              data-title={item.title.toLowerCase()}
              data-desc={item.desc.toLowerCase()}
            >
              <div class="flex items-start gap-3 mb-3">
                <div class="w-16 h-16 flex-shrink-0 rounded-lg overflow-hidden bg-neutral-100 dark:bg-neutral-800">
                  <img
                    src={item.imgurl}
                    alt={item.title}
                    class="w-full h-full object-cover"
                  />
                </div>
                <div class="flex-1 min-w-0">
                  <h3 class="font-bold text-base text-neutral-900 dark:text-neutral-100 mb-1 truncate">
                    {item.title}
                  </h3>
                  <p class="text-xs text-neutral-500 line-clamp-2">
                    {item.desc}
                  </p>
                </div>
              </div>
              
              <div class="flex items-center justify-between">
                <div class="flex gap-1 flex-wrap">
                  {item.tags && item.tags.length > 0 ? (
                    item.tags.map((tag) => (
                      <span class="px-2 py-0.5 text-xs rounded bg-neutral-100 dark:bg-neutral-800 text-neutral-600 dark:text-neutral-400">
                        {tag}
                      </span>
                    ))
                  ) : (
                    <span class="text-xs text-neutral-400">无标签</span>
                  )}
                </div>
                <a
                  href={item.siteurl}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="flex items-center justify-center w-8 h-8 rounded-lg bg-[var(--primary)] hover:bg-[var(--primary)]/80 text-white transition-colors flex-shrink-0"
                  title="访问网站"
                >
                  <Icon icon="material-symbols:arrow-outward" class="text-lg"></Icon>
                </a>
              </div>
            </div>
          ))}
        </div>

        <!-- 无结果提示 -->
        <div id="no-results" class="hidden text-center py-12 text-neutral-400">
          <Icon icon="material-symbols:search-off" class="text-5xl mb-3 mx-auto"></Icon>
          <p>没有找到匹配的友链</p>
        </div>
      </div>

      <!-- 申请说明区域 -->
      <div class="mt-12 pt-8 border-t border-neutral-200 dark:border-neutral-700">
        <h2 class="text-2xl font-bold mb-6">在申请友链之前，请先确认贵站是否符合以下基本要求：</h2>
        <ul class="space-y-3 mb-8 text-neutral-700 dark:text-neutral-300">
          <li class="flex items-start gap-2">
            <span class="text-green-500 mt-1">•</span>
            <span>能在中国大陆正常访问</span>
          </li>
          <li class="flex items-start gap-2">
            <span class="text-green-500 mt-1">•</span>
            <span>已经启用全站 <strong>强制 HTTPS</strong></span>
          </li>
          <li class="flex items-start gap-2">
            <span class="text-green-500 mt-1">•</span>
            <span>博客访问速度与性能优化较好（不包含仅依赖 Cloudflare 绕过）</span>
          </li>
          <li class="flex items-start gap-2">
            <span class="text-green-500 mt-1">•</span>
            <span>申请前请先添加本站为友情链接</span>
          </li>
        </ul>

        <h2 class="text-2xl font-bold mb-6">怎么加入友链？</h2>
        <ul class="space-y-3 mb-8 text-neutral-700 dark:text-neutral-300">
          <li class="flex items-start gap-2">
            <span class="text-green-500 mt-1">•</span>
            <span>内容合法合规</span>
          </li>
          <li class="flex items-start gap-2">
            <span class="text-green-500 mt-1">•</span>
            <span>是博客网站，或含有本人博客链接的任意网页（特例需特殊渠道）</span>
          </li>
          <li class="flex items-start gap-2">
            <span class="text-green-500 mt-1">•</span>
            <span>不接受大量非原创内容的网站</span>
          </li>
        </ul>

        <h2 class="text-2xl font-bold mb-4">本站信息</h2>
        <div class="bg-neutral-50 dark:bg-neutral-800 rounded-lg p-6 mb-8">
          <table class="w-full text-sm">
            <tbody class="divide-y divide-neutral-200 dark:divide-neutral-700">
              <tr>
                <td class="py-3 font-medium text-neutral-600 dark:text-neutral-400 w-24">项目</td>
                <td class="py-3 text-neutral-900 dark:text-neutral-100">值</td>
              </tr>
              <tr>
                <td class="py-3 font-medium text-neutral-600 dark:text-neutral-400">网站名称</td>
                <td class="py-3 text-neutral-900 dark:text-neutral-100">Jiublog</td>
              </tr>
              <tr>
                <td class="py-3 font-medium text-neutral-600 dark:text-neutral-400">网址</td>
                <td class="py-3">
                  <a href="https://jiujiu532.github.io/Xtower-Blog/" target="_blank" class="text-[var(--primary)] hover:underline">
                    https://jiujiu532.github.io/Xtower-Blog/
                  </a>
                </td>
              </tr>
              <tr>
                <td class="py-3 font-medium text-neutral-600 dark:text-neutral-400">头像 URL</td>
                <td class="py-3">
                  <a href="https://jiujiu532.github.io/Xtower-Blog/assets/images/avatar.jpg" target="_blank" class="text-[var(--primary)] hover:underline break-all">
                    https://jiujiu532.github.io/Xtower-Blog/assets/images/avatar.jpg
                  </a>
                </td>
              </tr>
              <tr>
                <td class="py-3 font-medium text-neutral-600 dark:text-neutral-400">介绍</td>
                <td class="py-3 text-neutral-900 dark:text-neutral-100">能够尽情享受喜欢的东西，才是最幸福的人生！</td>
              </tr>
            </tbody>
          </table>
        </div>

        <h2 class="text-2xl font-bold mb-4">申请格式</h2>
        <div class="bg-neutral-900 dark:bg-neutral-950 rounded-lg p-4 mb-4 overflow-x-auto">
          <pre class="text-sm text-neutral-100"><code>{`{
  title: "你的网站名称",
  imgurl: "你的头像地址",
  desc: "你的网站简介",
  siteurl: "你的网站地址",
  tags: ["Friend"],
}`}</code></pre>
        </div>
        <p class="text-neutral-600 dark:text-neutral-400">
          请将以上信息发送邮件至：<a href="mailto:2713775792@qq.com" class="text-[var(--primary)] hover:underline font-medium">2713775792@qq.com</a>
        </p>
      </div>
    </div>
  </div>

  <!-- 评论区 -->
  <div class="mt-4">
    <Comment post={friendsPost} customPath="/friends/" />
  </div>
</MainGridLayout>

<style>

  .filter-tag {
    padding: 0.375rem 0.75rem;
    font-size: 0.875rem;
    border-radius: 0.5rem;
    background: var(--card-bg);
    color: var(--text-color);
    border: 1px solid var(--line-divider);
    transition: all 0.2s;
    cursor: pointer;
  }
  .filter-tag:hover {
    background: var(--btn-hover-bg);
  }
  .filter-tag.active {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
  }
  .friend-card {
    transition: transform 0.2s;
  }
  .friend-card:hover {
    transform: translateY(-2px);
  }
  .friend-card.hidden {
    display: none;
  }
</style>

<script is:inline>
  function initFriends() {
    const searchInput = document.getElementById('search-input');
    const filterTags = document.querySelectorAll('.filter-tag');
    const friendCards = document.querySelectorAll('.friend-card');
    const noResults = document.getElementById('no-results');

    let currentTag = 'all';
    let currentSearch = '';

    // 标签筛选
    filterTags.forEach(tag => {
      tag.addEventListener('click', () => {
        filterTags.forEach(t => t.classList.remove('active'));
        tag.classList.add('active');
        currentTag = tag.getAttribute('data-tag') || 'all';
        filterCards();
      });
    });

    // 搜索功能
    searchInput?.addEventListener('input', (e) => {
      currentSearch = e.target.value.toLowerCase();
      filterCards();
    });

    // 筛选卡片
    function filterCards() {
      let visibleCount = 0;
      
      friendCards.forEach(card => {
        const tags = card.getAttribute('data-tags') || '';
        const title = card.getAttribute('data-title') || '';
        const desc = card.getAttribute('data-desc') || '';
        
        const matchTag = currentTag === 'all' || tags.includes(currentTag);
        const matchSearch = currentSearch === '' || 
                           title.includes(currentSearch) || 
                           desc.includes(currentSearch);
        
        if (matchTag && matchSearch) {
          card.classList.remove('hidden');
          visibleCount++;
        } else {
          card.classList.add('hidden');
        }
      });

      // 显示/隐藏无结果提示
      if (visibleCount === 0) {
        noResults?.classList.remove('hidden');
      } else {
        noResults?.classList.add('hidden');
      }
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initFriends);
  } else {
    initFriends();
  }
</script>
