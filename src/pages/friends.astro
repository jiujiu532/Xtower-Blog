---
import { getEntry, render } from "astro:content";
import Markdown from "@components/misc/Markdown.astro";
import I18nKey from "@/i18n/i18nKey";
import { i18n } from "@/i18n/translation";
import MainGridLayout from "@/layouts/MainGridLayout.astro";
import { getEnabledFriends } from "@/config";
import Comment from "@components/comment/index.astro";
import Icon from "@/components/misc/Icon.astro";

const friendsPost = await getEntry("spec", "friends");

if (!friendsPost) {
  throw new Error("friends page content not found");
}

const { Content } = await render(friendsPost);

// 使用配置文件中的友链数据，按权重排序
const items = getEnabledFriends();

// 获取所有标签
const allTags = new Set<string>();
items.forEach(item => {
  if (item.tags) {
    item.tags.forEach(tag => allTags.add(tag));
  }
});

// 页面标题和描述
const title = i18n(I18nKey.friends);
const description = i18n(I18nKey.friendsDescription);
---

<MainGridLayout title={title} description={description}>
  <div class="flex w-full rounded-[var(--radius-large)] overflow-hidden relative min-h-32">
    <div class="card-base z-10 px-9 py-6 relative w-full">
      <!-- 页面标题和描述 -->
      <div class="mb-6">
        <div class="flex items-center gap-3 mb-3">
          <div class="h-8 w-8 rounded-lg bg-[var(--primary)] flex items-center justify-center text-white dark:text-black/70">
            <Icon icon="material-symbols:group" class="text-[1.5rem]"></Icon>
          </div>
          <h1 class="text-3xl font-bold text-neutral-900 dark:text-neutral-100">
            {title}
          </h1>
        </div>
        {description && (
          <p class="text-base text-neutral-600 dark:text-neutral-400 leading-relaxed mb-4">
            {description}
          </p>
        )}
      </div>

      <!-- 分类切换按钮 -->
      <div class="flex gap-3 mb-6">
        <button 
          id="btn-friends" 
          class="tab-btn active px-4 py-2 rounded-lg font-medium transition-all flex items-center gap-2"
        >
          <Icon icon="material-symbols:group" class="text-lg"></Icon>
          友链列表 ({items.length})
        </button>
        <button 
          id="btn-apply" 
          class="tab-btn px-4 py-2 rounded-lg font-medium transition-all flex items-center gap-2"
        >
          <Icon icon="material-symbols:info-outline" class="text-lg"></Icon>
          申请说明
        </button>
      </div>
      
      <!-- 友链列表区域 -->
      <div id="friends-section" class="section-content">
        <!-- 搜索框 -->
        <div class="mb-4">
          <div class="relative">
            <Icon icon="material-symbols:search" class="absolute left-3 top-1/2 -translate-y-1/2 text-neutral-400 text-xl"></Icon>
            <input 
              type="text" 
              id="search-input"
              placeholder="搜索友链名称或描述..."
              class="w-full pl-10 pr-4 py-2 rounded-lg bg-neutral-100 dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700 focus:outline-none focus:border-[var(--primary)] transition-colors"
            />
          </div>
        </div>

        <!-- 标签筛选 -->
        <div class="flex gap-2 mb-6 flex-wrap">
          <button class="filter-tag active" data-tag="all">
            全部
          </button>
          {Array.from(allTags).map(tag => (
            <button class="filter-tag" data-tag={tag}>
              {tag}
            </button>
          ))}
        </div>

        <!-- 友链卡片网格 -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="friends-grid">
          {items.map((item) => (
            <div 
              class="friend-card card-base p-4 transition-all hover:shadow-lg"
              data-tags={item.tags?.join(',') || ''}
              data-title={item.title.toLowerCase()}
              data-desc={item.desc.toLowerCase()}
            >
              <div class="flex items-start gap-3 mb-3">
                <div class="w-16 h-16 flex-shrink-0 rounded-lg overflow-hidden bg-neutral-100 dark:bg-neutral-800">
                  <img
                    src={item.imgurl}
                    alt={item.title}
                    class="w-full h-full object-cover"
                  />
                </div>
                <div class="flex-1 min-w-0">
                  <h3 class="font-bold text-base text-neutral-900 dark:text-neutral-100 mb-1 truncate">
                    {item.title}
                  </h3>
                  <p class="text-xs text-neutral-500 line-clamp-2">
                    {item.desc}
                  </p>
                </div>
              </div>
              
              <div class="flex items-center justify-between">
                <div class="flex gap-1 flex-wrap">
                  {item.tags && item.tags.length > 0 ? (
                    item.tags.map((tag) => (
                      <span class="px-2 py-0.5 text-xs rounded bg-neutral-100 dark:bg-neutral-800 text-neutral-600 dark:text-neutral-400">
                        {tag}
                      </span>
                    ))
                  ) : (
                    <span class="text-xs text-neutral-400">无标签</span>
                  )}
                </div>
                <a
                  href={item.siteurl}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="flex items-center justify-center w-8 h-8 rounded-lg bg-[var(--primary)] hover:bg-[var(--primary)]/80 text-white transition-colors flex-shrink-0"
                  title="访问网站"
                >
                  <Icon icon="material-symbols:arrow-outward" class="text-lg"></Icon>
                </a>
              </div>
            </div>
          ))}
        </div>

        <!-- 无结果提示 -->
        <div id="no-results" class="hidden text-center py-12 text-neutral-400">
          <Icon icon="material-symbols:search-off" class="text-5xl mb-3 mx-auto"></Icon>
          <p>没有找到匹配的友链</p>
        </div>
      </div>

      <!-- 申请说明区域 -->
      <div id="apply-section" class="section-content hidden">
        <Markdown class="mt-2">
          <Content />
        </Markdown>
      </div>
    </div>
  </div>

  <!-- 评论区 -->
  <div class="mt-4">
    <Comment post={friendsPost} customPath="/friends/" />
  </div>
</MainGridLayout>

<style>
  .tab-btn {
    background: var(--card-bg);
    color: var(--text-color);
    border: 1px solid var(--line-divider);
  }
  .tab-btn:hover {
    background: var(--btn-hover-bg);
  }
  .tab-btn.active {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
  }
  .section-content.hidden {
    display: none;
  }
  .filter-tag {
    padding: 0.375rem 0.75rem;
    font-size: 0.875rem;
    border-radius: 0.5rem;
    background: var(--card-bg);
    color: var(--text-color);
    border: 1px solid var(--line-divider);
    transition: all 0.2s;
    cursor: pointer;
  }
  .filter-tag:hover {
    background: var(--btn-hover-bg);
  }
  .filter-tag.active {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
  }
  .friend-card {
    transition: transform 0.2s;
  }
  .friend-card:hover {
    transform: translateY(-2px);
  }
  .friend-card.hidden {
    display: none;
  }
</style>

<script is:inline>
  function initFriends() {
    const btnFriends = document.getElementById('btn-friends');
    const btnApply = document.getElementById('btn-apply');
    const friendsSection = document.getElementById('friends-section');
    const applySection = document.getElementById('apply-section');
    const searchInput = document.getElementById('search-input');
    const filterTags = document.querySelectorAll('.filter-tag');
    const friendCards = document.querySelectorAll('.friend-card');
    const noResults = document.getElementById('no-results');

    let currentTag = 'all';
    let currentSearch = '';

    // 切换主分类
    btnFriends?.addEventListener('click', () => {
      btnFriends.classList.add('active');
      btnApply?.classList.remove('active');
      friendsSection?.classList.remove('hidden');
      applySection?.classList.add('hidden');
    });

    btnApply?.addEventListener('click', () => {
      btnApply.classList.add('active');
      btnFriends?.classList.remove('active');
      applySection?.classList.remove('hidden');
      friendsSection?.classList.add('hidden');
    });

    // 标签筛选
    filterTags.forEach(tag => {
      tag.addEventListener('click', () => {
        filterTags.forEach(t => t.classList.remove('active'));
        tag.classList.add('active');
        currentTag = tag.getAttribute('data-tag') || 'all';
        filterCards();
      });
    });

    // 搜索功能
    searchInput?.addEventListener('input', (e) => {
      currentSearch = (e.target as HTMLInputElement).value.toLowerCase();
      filterCards();
    });

    // 筛选卡片
    function filterCards() {
      let visibleCount = 0;
      
      friendCards.forEach(card => {
        const tags = card.getAttribute('data-tags') || '';
        const title = card.getAttribute('data-title') || '';
        const desc = card.getAttribute('data-desc') || '';
        
        const matchTag = currentTag === 'all' || tags.includes(currentTag);
        const matchSearch = currentSearch === '' || 
                           title.includes(currentSearch) || 
                           desc.includes(currentSearch);
        
        if (matchTag && matchSearch) {
          card.classList.remove('hidden');
          visibleCount++;
        } else {
          card.classList.add('hidden');
        }
      });

      // 显示/隐藏无结果提示
      if (visibleCount === 0) {
        noResults?.classList.remove('hidden');
      } else {
        noResults?.classList.add('hidden');
      }
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initFriends);
  } else {
    initFriends();
  }
</script>
